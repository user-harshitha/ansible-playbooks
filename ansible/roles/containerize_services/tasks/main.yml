- name: Ensure the /app/docker directory exists
  file:
    path: /app/docker
    state: directory
    mode: '0755'
- name: Update docker folder with docker-compose file
  template:
    src: containerized-services/docker-compose.yml
    dest: /app/docker/docker-compose.yml
    mode: '0644'
- name: Ensure the /app/services/mysql-8.0/config/ directory exists
  file:
    path: /app/services/mysql-8.0/config/
    state: directory
    mode: '0755'
- name: Update mysql folder with mysqld.cnf file
  template:
    src: containerized-services/mysql/mysqld.cnf
    dest: /app/services/mysql-8.0/config/mysqld.cnf
    mode: '0644'
- name: Ensure the /app/services/php-8.3/ directory exists
  file:
    path: /app/services/php-8.3/
    state: directory
    mode: '0755'
- name: 'Update PHP folder with cli, fpm config files'
  copy:
    src: roles/containerize_services/templates/containerized-services/php-8.3
    dest: /app/services/php-8.3
    mode: '0755'
    recursive: 'yes'
- name: Bring up Docker Compose services
  command: docker compose -f /app/docker/docker-compose.yml up -d
- name: configure docker-compose service systemd files
  template:
    src: 'containerized-services/{{ item }}'
    dest: /etc/systemd/system/
  with_items:
    - docker-compose.service
- name: setting permissions for systemd services
  file:
    dest: '/etc/systemd/system/{{ item }}'
    owner: root
    group: root
    mode: 'u=rwX,g=rX,o=rX'
  with_items:
    - docker-compose.service
- name: Restart docker-compose service (with daemon reload)
  systemd:
    name: '{{ item }}'
    state: started
    daemon_reload: 'yes'
    enabled: 'yes'
  with_items:
    - docker-compose.service

